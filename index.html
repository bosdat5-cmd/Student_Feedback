<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Student Feedback Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .form-page { display: none; }
  .form-page.active { display: block; }
  .faculty-card { transition: all 0.3s ease; }
  .faculty-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  .progress-bar { transition: width 0.5s ease-in-out; }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="container mx-auto px-4 py-8 max-w-4xl">

  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-black mb-1">THE INSTITUTE OF CHARTERED ACCOUNTANTS OF INDIA</h1>
    <h2 class="text-4xl font-bold text-blue-800 mb-4">STUDENT FEEDBACK FORM</h2>
    <p class="text-gray-600">Your feedback helps us improve the quality of education</p>
  </div>

  <!-- Progress Bar -->
  <div class="mb-8 bg-white rounded-lg shadow-sm p-4">
    <div class="flex justify-between items-center mb-2">
      <span class="text-sm font-medium text-gray-700">Progress</span>
      <span class="text-sm font-medium text-blue-600" id="progress-text">0%</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2">
      <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width:0%"></div>
    </div>
  </div>

  <!-- Page 1: Student Info -->
<div id="page1" class="form-page active bg-white rounded-lg shadow-md p-6">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">Student Information</h2>
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
      <input type="text" id="studentName" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Enter your full name">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Registration Number *</label>
      <input type="text" id="regNumber" class="w-full px-4 py-2 border border-gray-300 rounded-md"
             placeholder="AAA1234567" pattern="[A-Za-z]{3}[0-9]{7}"
             title="Format: 3 letters followed by 7 digits (e.g., ABC1234567)" required>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Email ID *</label>
      <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Enter email address">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number *</label>
      <input type="tel" id="mobile" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Enter mobile number">
    </div>
  </div>
  <div class="mt-8 flex justify-end">
    <button onclick="validatePage1()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
      Next → Select Faculty
    </button>
  </div>
</div>

<!-- Page 2: Faculty Selection (only once, outside page1) -->
<div id="page2" class="form-page bg-white rounded-lg shadow-md p-6">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">Select Faculty for Feedback</h2>
  <p class="text-gray-600 mb-6">Please select one faculty at a time. Completed faculties are highlighted in green.</p>
  <div id="facultyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>
  <!-- Page 3: Faculty Feedback -->
  <div id="page3" class="form-page bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-2">Feedback for <span id="currentFaculty" class="text-blue-600"></span></h2>
    <p class="text-gray-600 mb-6">Please answer all questions:</p>
    <div class="space-y-6" id="questionsContainer">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Batch ID *</label>
        <input type="text" id="batchId" class="w-full px-4 py-2 border border-gray-300 rounded-md">
      </div>
      <!-- Ratings 1-5 (options carry text like "1: Poor") -->
      <div>
        <label>Attendance & Punctuality *</label>
        <select id="attendance" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Professional Dress Code *</label>
        <select id="dressCode" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Discipline & Conduct *</label>
        <select id="discipline" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Active Participation *</label>
        <select id="participation" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Group Activities & Teamwork *</label>
        <select id="teamwork" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Presentation Content *</label>
        <select id="presentationContent" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Presentation Delivery *</label>
        <select id="presentationDelivery" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Communication Skills *</label>
        <select id="communication" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Analytical Thinking *</label>
        <select id="analytical" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Creativity & Innovation *</label>
        <select id="creativity" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Professional Ethics Awareness *</label>
        <select id="ethics" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Emotional Intelligence *</label>
        <select id="emotional" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Overall Engagement *</label>
        <select id="overallEngagement" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select rating</option>
          <option>1: Poor</option><option>2: Below Average</option><option>3: Average</option><option>4: Good</option><option>5: Excellent</option>
        </select>
      </div>
      <div>
        <label>Quiz Marks *</label>
        <input type="text" id="quizMarks" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="e.g. 99%">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Weighted Score</label>
        <span id="weightedScoreDisplay" class="block px-4 py-2 border border-gray-300 rounded-md bg-gray-100">0</span>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Grade</label>
        <span id="gradeDisplay" class="block px-4 py-2 border border-gray-300 rounded-md bg-gray-100">-</span>
      </div>
    </div>

    <div class="mt-8 flex justify-between">
      <button onclick="showFacultySelection()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">← Back</button>
      <button onclick="submitFacultyFeedback()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Next →</button>
    </div>
  </div>

  <!-- Page 4: Completion -->
  <div id="page4" class="form-page bg-white rounded-lg shadow-md p-6 text-center">
    <div class="mb-6">
      <img src="https://placehold.co/200x200" alt="Success" class="mx-auto rounded-full" onerror="this.style.display='none'">
    </div>
    <h2 class="text-3xl font-bold text-green-600 mb-4">All Feedback Submitted Successfully!</h2>
    <p class="text-gray-600 mb-6">Thank you for your valuable feedback.</p>
  </div>

</div>

<script>
let faculties = ["Sandeep Agarwal","Bhanu Dhir","Shekhar Sharma","Anju Gupta","Preeti Goel","Rohit Agarwal","Sunita Rathore"];
let completedFaculties = [];
let selectedFacultyIndex = -1;
let totalFaculties = faculties.length;

const scoreMap = { "POOR":20, "BELOW AVERAGE":40, "AVERAGE":60, "GOOD":80, "EXCELLENT":100 };

function showPage(pageId){
  document.querySelectorAll('.form-page').forEach(p=>p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
}

function updateProgress(){
  const percent = Math.round((completedFaculties.length / totalFaculties) * 100);
  document.querySelector('.progress-bar').style.width = percent + '%';
  document.getElementById('progress-text').textContent = percent + '%';
}

function validatePage1(){
  // 🔥 Make sure these IDs exist in HTML <input> tags
  const fullName = document.getElementById("studentName").value.trim(); // 🔥 FIXED id must exist in HTML
  const regNumber = document.getElementById("regNumber").value.trim();
  const email = document.getElementById("email").value.trim();
  const mobile = document.getElementById("mobile").value.trim();

  if (!fullName || !regNumber || !email || !mobile) {
    alert("Please fill all required fields.");
    return;
  }
  if (!/^[A-Za-z]{3}[0-9]{7}$/.test(regNumber)) {
    alert("Registration Number must be 3 letters followed by 7 digits.");
    return;
  }
  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Mobile number must be exactly 10 digits.");
    return;
  }
  showFacultySelection(); // 🔥 this will now go to page2
}

function showFacultySelection() {
  showPage('page2');
  const grid = document.getElementById('facultyGrid');
  grid.innerHTML = '';
  faculties.forEach((f, idx) => {
    const card = document.createElement('div');
    card.className = 'faculty-card p-4 border rounded-md text-center ' +
      (completedFaculties.includes(f) ? 'bg-green-200 cursor-not-allowed' : 'bg-gray-50 cursor-pointer');
    card.innerHTML = `<h3 class="font-semibold">${f}</h3>`;
    if (!completedFaculties.includes(f)) {
      card.onclick = () => { selectedFacultyIndex = idx; startFeedback(); };
    }
    grid.appendChild(card);
  });
}

function startFeedback(){
  showPage('page3');
  document.getElementById('currentFaculty').innerText = faculties[selectedFacultyIndex];

  document.querySelectorAll('#questionsContainer select').forEach(el => el.selectedIndex = 0);
  document.getElementById('quizMarks').value = '';
  document.getElementById('batchId').value = '';

  const allSelects = document.querySelectorAll('#questionsContainer select');
  allSelects.forEach(el => el.onchange = calculateWeighted);
  document.getElementById('quizMarks').oninput = calculateWeighted;
}

function calculateWeighted(){
  const allSelects = document.querySelectorAll('#questionsContainer select');
  let total = 0, count = 0;
  allSelects.forEach(el => {
    if (el.selectedIndex > 0) {
      const val = el.value.split(":")[1].trim().toUpperCase();
      total += scoreMap[val];
      count++;
    }
  });
  const quizInput = parseFloat(document.getElementById('quizMarks').value) || 0;
  const avgMarks = count ? total / count : 0;
  const weightedScore = (avgMarks + quizInput) / 2;

  let grade = "-";
  if (weightedScore >= 90) grade = "A+";
  else if (weightedScore >= 80) grade = "A";
  else if (weightedScore >= 70) grade = "B+";
  else if (weightedScore >= 50) grade = "B";
  else if (weightedScore >= 30) grade = "C";

  document.getElementById('weightedScoreDisplay').innerText = weightedScore.toFixed(2);
  document.getElementById('gradeDisplay').innerText = grade;
}

function submitFacultyFeedback(){
  if(selectedFacultyIndex === -1){
    alert("Please select a faculty first.");
    return;
  }

  const selects = document.querySelectorAll('#questionsContainer select');
  for (let sel of selects) {
    if (sel.selectedIndex === 0) {
      alert("Please answer all questions before submitting.");
      return;
    }
  }

  const quizMarks = parseFloat(document.getElementById('quizMarks').value);
  if (isNaN(quizMarks) || quizMarks < 0) {
    alert("Enter valid quiz marks.");
    return;
  }

  const payload = {
    name: document.getElementById("studentName").value,
    regNumber: document.getElementById("regNumber").value,
    email: document.getElementById("email").value,
    mobile: document.getElementById("mobile").value,
    faculty: faculties[selectedFacultyIndex],
    batchId: document.getElementById("batchId").value,
    quizMarks,
    weightedScore: document.getElementById("weightedScoreDisplay").innerText,
    grade: document.getElementById("gradeDisplay").innerText
  };

  fetch("https://script.google.com/macros/s/🔥REPLACE_WITH_YOUR_DEPLOYMENT_ID🔥/exec", { // 🔥 FIXED
    method: "POST",
    body: JSON.stringify(payload),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.text())
  .then(() => {
    completedFaculties.push(faculties[selectedFacultyIndex]);
    updateProgress();
    if (completedFaculties.length === totalFaculties) {
      showPage("page4");
    } else {
      showFacultySelection();
    }
  })
  .catch(err => alert("Error submitting feedback: " + err));
}
</script>
